# --- BLOCO 1: Redirecionar todo o tráfego HTTP (porta 80) para HTTPS ---
# Este bloco apanha qualquer pedido para as versões não seguras do seu site.
server {
    listen 80;
    listen [::]:80;
    server_name ativos.pt www.ativos.pt;

    # A única função deste bloco é redirecionar permanentemente (301)
    # para a versão segura (HTTPS) e canónica (www), mantendo o resto do URL.
    return 301 https://www.ativos.pt$request_uri;
}


# --- BLOCO 2: Configuração principal do site em HTTPS (porta 443) ---
# É aqui que o seu site realmente "vive".
server {
    # O servidor vai "ouvir" na porta 443, a porta padrão para HTTPS/SSL
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # O nome do servidor canónico
    server_name www.ativos.pt;

    # --- IMPORTANTE: CAMINHO PARA OS SEUS CERTIFICADOS SSL ---
    # Substitua pelos caminhos corretos onde os seus certificados estão guardados.
    # Se usar Certbot/Let's Encrypt, os caminhos serão semelhantes a estes.
    ssl_certificate /etc/letsencrypt/live/ativos.pt/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ativos.pt/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;


    # A localização dos ficheiros do nosso site dentro do contentor Docker
    root /usr/share/nginx/html;
    index index.html;

    # Redirecionamento 301 para a nova estrutura de URLs do comparador
    location ~ ^/comparar/(.*)$ {
        return 301 https://$host/plataformas/comparar/$1;
    }

    location / {
        # Tenta encontrar um ficheiro com o nome exato do pedido.
        # Se não encontrar, tenta encontrar uma pasta com esse nome.
        # Se falhar, devolve o ficheiro /index.html (importante para o routing do Astro).
        try_files $uri $uri/ /index.html;
    }

    # Otimizações para performance e segurança
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Configurações de Gzip para comprimir os ficheiros e acelerar o site
    gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}

# Bloco final para redirecionar a versão não-www para www em HTTPS
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ativos.pt;

    # Caminhos para os certificados SSL (repetido)
    ssl_certificate /etc/letsencrypt/live/ativos.pt/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ativos.pt/privkey.pem;

    # Redireciona para a versão www
    return 301 https://www.ativos.pt$request_uri;
}