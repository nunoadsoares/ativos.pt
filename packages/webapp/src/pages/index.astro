---
// A TUA L√ìGICA - 100% INTACTA E RESPEITADA
import BaseLayout from '~/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import Sparkline from '~/components/Sparkline.tsx';
import fs from 'node:fs/promises';

export const prerender = true;

// --- Dados est√°ticos ---
import housingKpiData from '../../public/data-housing-kpi.json';
import conditionsData from '../../public/data/credito_habitacao_condicoes.json';
import exchangeData from '../../public/data/exchange_rates_monthly.json';
import inflationData from '../../public/data/inflation_summary.json';

// --- KPI setup ---
let kpis = {
  housing:   { value: 0, trend: [] as number[], color: '#ef4444' },
  tan:       { value: 'N/D', trend: [] as number[]        },
  exchange:  { value: 'N/D', trend: [] as number[]        },
  inflation: { value: 'N/D', trend: [] as number[]        }
};

async function parseCsvHistory(path: string): Promise<[number,number][]> {
  try {
    const url = new URL(path, import.meta.url);
    const txt = await fs.readFile(url, 'utf-8');
    return txt
      .trim().split('\n').slice(1)
      .map(l => l.split(','))
      .filter(([,v]) => v && !isNaN(+v))
      .map(([d,v]) => [new Date(d).getTime(), parseFloat(v)]);
  } catch {
    return [];
  }
}

try {
  // Habita√ß√£o
  const h = await parseCsvHistory('../../public/data/house_price_index_total.csv');
  kpis.housing.value = housingKpiData.value ?? 0;
  kpis.housing.trend = h.slice(-12).map(p => p[1]);
  kpis.housing.color = kpis.housing.value > 0 ? '#ef4444' : '#22c55e';

  // TAN
  if (conditionsData.length > 0) {
    const last = conditionsData.at(-1)!;
    kpis.tan.value = last.tan_variavel?.toFixed(2) ?? 'N/D';
    kpis.tan.trend = conditionsData.slice(-12).map(d => d.tan_variavel);
  }

  // EUR/USD
  if (exchangeData.length > 0) {
    const last = exchangeData.at(-1)!;
    kpis.exchange.value = last.usd?.toFixed(3) ?? 'N/D';
    kpis.exchange.trend = exchangeData.slice(-12).map(d => d.usd);
  }

  // Infla√ß√£o (sem seta)
  const yoy = inflationData.historical.yoy;
  if (yoy.length >= 2) {
    const a = yoy.at(-1)![1];
    kpis.inflation.value = a.toFixed(2);
    kpis.inflation.trend = yoy.slice(-12).map(p => p[1]);
  }
} catch (e) {
  console.error('Erro a calcular KPIs:', e);
}

// Collections
const [guiasFiscais, plataformas] = await Promise.all([
  getCollection('fiscais'),
  getCollection('plataformas')
]);
const guiasFiscaisDestaque = guiasFiscais.slice(0,4);
const plataformasDestaque = plataformas.slice(0,5);

// Tools
const tools = [
  { slug:'/inflacao',               titulo:'Observat√≥rio da Infla√ß√£o', desc:'Acompanhe o IPC, hist√≥rico e reparti√ß√£o por setor.', emoji:'üìä' },
  { slug:'/imobiliario',          titulo:'Observat√≥rio Imobili√°rio', desc:'Pre√ßos, cr√©dito, risco e outros indicadores.', emoji:'üè†' },
  { slug:'/euribor',              titulo:'Observat√≥rio da Euribor',   desc:'Evolu√ß√£o das taxas que definem o seu cr√©dito.', emoji:'üá™üá∫' },
  { slug:'/simuladores/salario-liquido', titulo:'Simulador Sal√°rio L√≠quido', desc:'Calcule descontos e valor l√≠quido.', emoji:'üí∂' },
  { slug:'/simuladores/mais-valias',    titulo:'Simulador Mais-Valias',     desc:'Apure imposto de a√ß√µes e ETFs.', emoji:'üìà' },
  { slug:'/plataformas/comparar',       titulo:'Comparador de Corretoras',   desc:'Compare taxas, regula√ß√£o e custos.', emoji:'‚öñÔ∏è' }
];

// FAQ schema
const faqSchema = {
  "@context":"https://schema.org",
  "@type":"FAQPage",
  mainEntity: [
    { "@type":"Question", name:"O que encontro no Ativos.pt?", acceptedAnswer:{ "@type":"Answer", text:"Indicadores atualizados, simuladores e guias pr√°ticos." } },
    { "@type":"Question", name:"√â gratuito?", acceptedAnswer:{ "@type":"Answer", text:"Sim, sem registo e totalmente gratuito." } },
    { "@type":"Question", name:"Os dados s√£o fi√°veis?", acceptedAnswer:{ "@type":"Answer", text:"Recolhidos de fontes oficiais (BPstat e INE)." } }
  ]
};
---

<BaseLayout
    title="Ativos.pt ‚Äì O Dashboard Financeiro de Portugal"
    description="Dados de mercado em tempo real, simuladores e guias pr√°ticos para investir com confian√ßa."
>
    <Fragment slot="head">
        <script type="application/ld+json" is:inline set:html={JSON.stringify(faqSchema)} />
    </Fragment>

    <main class="bg-gray-50 dark:bg-brand-dark">

        <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-14 pb-20 text-center">
            <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight text-gray-900 dark:text-white">
                O Dashboard Financeiro de <span class="text-primary">Portugal</span>
            </h1>
            <p class="mt-6 max-w-2xl mx-auto text-lg text-gray-600 dark:text-gray-300">
                Indicadores chave, ferramentas pr√°ticas e guias atualizados. Tome decis√µes com dados.
            </p>

            <div class="mt-12 grid grid-cols-2 md:grid-cols-4 gap-4 max-w-5xl mx-auto">
                <a href="/inflacao" class="group block p-4 rounded-xl border bg-white/70 dark:bg-gray-800/50 dark:border-gray-700 border-gray-200 hover:border-primary transition shadow-sm flex flex-col min-h-[110px] sm:min-h-[120px] overflow-hidden">
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 text-left">Infla√ß√£o (YoY)</h3>
                    <div class="flex-grow flex justify-between items-end mt-1 min-w-0">
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">{kpis.inflation.value}%</p>
                        <div class="flex-shrink-0 w-[80px] sm:w-[120px] overflow-hidden opacity-70 group-hover:opacity-100 transition-opacity">
                            <Sparkline client:only="react" seriesData={kpis.inflation.trend} color="#8b5cf6" />
                        </div>
                    </div>
                </a>
                <a href="/imobiliario/precos-habitacao" class="group block p-4 rounded-xl border bg-white/70 dark:bg-gray-800/50 dark:border-gray-700 border-gray-200 hover:border-primary transition shadow-sm flex flex-col min-h-[110px] sm:min-h-[120px] overflow-hidden">
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 text-left">Pre√ßo Habita√ß√£o (YoY)</h3>
                    <div class="flex-grow flex justify-between items-end mt-1 min-w-0">
                        <p class:list={["text-xl sm:text-2xl font-bold", kpis.housing.value > 0 ? "text-red-500" : "text-green-500"]}>
                            {kpis.housing.value > 0 ? '+' : ''}{kpis.housing.value}%
                        </p>
                        <div class="flex-shrink-0 w-[80px] sm:w-[120px] overflow-hidden opacity-70 group-hover:opacity-100 transition-opacity">
                            <Sparkline client:only="react" seriesData={kpis.housing.trend} color={kpis.housing.color} />
                        </div>
                    </div>
                </a>
                <a href="/imobiliario/condicoes-credito" class="group block p-4 rounded-xl border bg-white/70 dark:bg-gray-800/50 dark:border-gray-700 border-gray-200 hover:border-primary transition shadow-sm flex flex-col min-h-[120px] overflow-hidden">
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 text-left">TAN Cr√©dito</h3>
                    <div class="flex-grow flex justify-between items-end mt-1 min-w-0">
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">{kpis.tan.value}%</p>
                        <div class="flex-shrink-0 w-[80px] sm:w-[120px] overflow-hidden opacity-70 group-hover:opacity-100 transition-opacity">
                            <Sparkline client:only="react" seriesData={kpis.tan.trend} color="#3b82f6" />
                        </div>
                    </div>
                </a>
                <a href="/cambios" class="group block p-4 rounded-xl border bg-white/70 dark:bg-gray-800/50 dark:border-gray-700 border-gray-200 hover:border-primary transition shadow-sm flex flex-col min-h-[120px] overflow-hidden">
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 text-left">EUR / USD</h3>
                    <div class="flex-grow flex justify-between items-end mt-1 min-w-0">
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">{kpis.exchange.value}</p>
                        <div class="flex-shrink-0 w-[80px] sm:w-[120px] overflow-hidden opacity-70 group-hover:opacity-100 transition-opacity">
                            <Sparkline client:only="react" seriesData={kpis.exchange.trend} color="#10b981" />
                        </div>
                    </div>
                </a>
            </div>
        </section>

        <section class="bg-white dark:bg-gray-900/40 py-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center mb-14">
                <h2 class="text-4xl font-bold text-gray-900 dark:text-white">Ferramentas & Observat√≥rios</h2>
                <p class="mt-4 text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
                    Explore dashboards interativos e simuladores para as suas finan√ßas.
                </p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                {tools.map(tool => (
                    <a href={tool.slug} class="group block p-6 rounded-xl border bg-gray-50 dark:bg-gray-800/60 dark:border-gray-700 border-gray-200 hover:border-primary transition-all duration-300 shadow-sm hover:shadow-xl hover:-translate-y-1">
                        <div class="text-4xl mb-4">{tool.emoji}</div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white group-hover:text-primary">{tool.titulo}</h3>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">{tool.desc}</p>
                    </a>
                ))}
            </div>
        </section>

        <section class="py-20">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-14">
                    <h2 class="text-4xl font-bold text-gray-900 dark:text-white">Recursos para o Investidor</h2>
                    <p class="mt-4 text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
                        Desde guias fiscais detalhados a an√°lises de corretoras, temos a informa√ß√£o de que precisa para investir melhor.
                    </p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                    <div class="bg-white dark:bg-gray-800/60 p-8 rounded-2xl border border-gray-200 dark:border-gray-700 flex flex-col h-full shadow-sm">
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Corretoras em Destaque</h3>
                        <div class="space-y-4 flex-grow">
                            {plataformasDestaque.map((p) => (
                                <a href={`/plataformas/${p.slug}`} class="flex items-center gap-4 group p-4 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-900/50 transition">
                                    <img src={p.data.logo} alt={p.data.nome} class="h-10 w-10 object-contain rounded-full bg-white flex-shrink-0" />
                                    <div>
                                        <h4 class="font-bold text-gray-900 dark:text-white group-hover:text-primary">{p.data.nome}</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">{p.data.description}</p>
                                    </div>
                                </a>
                            ))}
                        </div>
                        <div class="mt-8 text-center">
                            <a href="/plataformas" class="inline-flex items-center gap-2 font-semibold text-primary hover:underline">
                                Ver Comparador de Corretoras
                            </a>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800/60 p-8 rounded-2xl border border-gray-200 dark:border-gray-700 flex flex-col h-full shadow-sm">
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Guias Fiscais Essenciais</h3>
                        <div class="space-y-4 flex-grow">
                            {guiasFiscaisDestaque.map((g) => (
                                <a href={`/guias-fiscais/${g.slug}`} class="flex items-start gap-4 group p-4 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-900/50 transition">
                                    <div class="flex-shrink-0 h-10 w-10 mt-1 rounded-lg bg-primary/10 flex items-center justify-center border border-primary/20">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900 dark:text-white group-hover:text-primary">{g.data.title}</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 line-clamp-2">{g.data.description}</p>
                                    </div>
                                </a>
                            ))}
                        </div>
                        <div class="mt-8 text-center">
                            <a href="/guias-fiscais" class="inline-flex items-center gap-2 font-semibold text-primary hover:underline">
                                Ver Todos os Guias
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-20 text-center">
            <h2 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white mb-4">
                Receba novidades e ferramentas novas
            </h2>
            <p class="text-gray-600 dark:text-gray-400 mb-8">Sem spam. Pode cancelar quando quiseres.</p>
            <form class="flex flex-col sm:flex-row gap-3 justify-center">
                <input type="email" placeholder="O teu email" class="w-full sm:w-80 px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 focus:ring-primary focus:border-primary" required />
                <button class="bg-primary text-white font-semibold py-3 px-8 rounded-xl hover:opacity-90 transition">
                    Subscrever
                </button>
            </form>
        </section>
    </main>
</BaseLayout>
