---
// src/pages/index.astro
import BaseLayout from '~/layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

export const prerender = true;

// --- DADOS PARA OS KPIS DA HOMEPAGE ---
let housingKpi = { value: 0 };
let tanInfo = { value: 'N/D' };
let exchangeInfo = { value: 'N/D' };
let riskInfo = { value: 'N/D' };

try {
  // Carrega todos os JSONs necess√°rios em paralelo
  const [housing, conditions, exchange, risk] = await Promise.all([
    import('../../public/data-housing-kpi.json').then(m => m.default),
    import('../../public/data/credito_habitacao_condicoes.json').then(m => m.default),
    import('../../public/data/exchange_rates_monthly.json').then(m => m.default),
    import('../../public/data/map_default_risk.json').then(m => m.default),
  ]);

  // KPI: Pre√ßo Habita√ß√£o
  housingKpi.value = housing.value ?? 0;

  // KPI: TAN Vari√°vel
  if (conditions.length > 0) {
    tanInfo.value = conditions[conditions.length - 1].tan_variavel?.toFixed(2) ?? 'N/D';
  }
  
  // KPI: C√¢mbio EUR/USD
  if (exchange.length > 0) {
      exchangeInfo.value = exchange[exchange.length - 1].usd?.toFixed(3) ?? 'N/D';
  }

  // KPI: Risco de Cr√©dito M√°ximo
  const validRegions = Object.values(risk).filter((r: any) => r && typeof r.value === 'number');
  if (validRegions.length > 0) {
    validRegions.sort((a: any, b: any) => b.value - a.value);
    riskInfo.value = (validRegions[0] as any).value.toFixed(2);
  }

} catch (e) {
  console.error("Falha ao carregar KPIs para a homepage:", e);
}

// --- COLE√á√ïES DE CONTE√öDO ---
const [guiasFiscais, plataformas] = await Promise.all([
  getCollection('fiscais'),
  getCollection('plataformas')
]);

const guiasFiscaisDestaque = guiasFiscais.slice(0, 3);
const plataformasDestaque = plataformas.slice(0, 3);

const simuladores = [
  { slug: 'salario-liquido', titulo: 'Sal√°rio L√≠quido 2025', desc: 'Calcula reten√ß√£o, SS e dedu√ß√µes.', emoji: 'üí∂' },
  { slug: 'englobamento-mais-valias', titulo: 'Englobamento de Mais-Valias', desc: 'Compara taxa liberat√≥ria vs englobar.', emoji: 'üßæ' },
  { slug: 'mais-valias', titulo: 'Mais-Valias de A√ß√µes & ETFs', desc: 'Apura imposto a pagar, com regra FIFO.', emoji: 'üìà' },
];

// --- FAQ SCHEMA RESTAURADO ---
const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "O que encontro no Ativos.pt?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Indicadores de mercado atualizados, simuladores fiscais e financeiros, um gloss√°rio de ativos e an√°lises detalhadas de corretoras usadas em Portugal."
      }
    },
    {
      "@type": "Question",
      "name": "Os simuladores do Ativos.pt s√£o gratuitos?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Sim. Todos os simuladores s√£o gratuitos e podem ser usados sem registo."
      }
    },
    {
      "@type": "Question",
      "name": "Posso comparar corretoras no Ativos.pt?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Sim. Temos um comparador de corretoras que permite analisar taxas, regula√ß√£o e custos anuais estimados de v√°rias plataformas."
      }
    },
    {
      "@type": "Question",
      "name": "Os dados fiscais est√£o adaptados a Portugal?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Sim. Todo o conte√∫do √© focado no contexto portugu√™s, incluindo tributa√ß√£o (IRS) e formul√°rios relevantes."
      }
    }
  ]
};
---

<BaseLayout
  title="Ativos.pt ‚Äì Investir em Portugal com Dados, Ferramentas e Guias Pr√°ticos"
  description="Indicadores de mercado, simuladores fiscais, guias passo a passo e comparador de corretoras. Menos ru√≠do, mais decis√µes informadas."
>
  <Fragment slot="head">
    <script type="application/ld+json" is:inline set:html={JSON.stringify(faqSchema)} />
  </Fragment>

  <main class="bg-gray-50 dark:bg-brand-dark">

    <!-- HERO E DASHBOARD DE KPIS -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-14 pb-20 text-center">
      <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight text-gray-900 dark:text-white">
        Investir em Portugal, <span class="text-primary">com Dados</span>
      </h1>
      <p class="mt-6 max-w-2xl mx-auto text-lg md:text-xl text-gray-600 dark:text-gray-300">
        Indicadores chave, simuladores pr√°ticos e guias fiscais atualizados. Tome decis√µes com dados, n√£o palpites.
      </p>

      <div class="mt-12 grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
        <a href="/imobiliario/precos-habitacao" class="block bg-white/70 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition">
            <h3 class="text-sm font-semibold text-gray-500">Pre√ßo Habita√ß√£o</h3>
            <p class:list={["text-2xl font-bold mt-1", housingKpi.value > 0 ? "text-red-500" : "text-green-500"]}>
                {housingKpi.value > 0 ? '+' : ''}{housingKpi.value}%
            </p>
        </a>
        <a href="/imobiliario/condicoes-credito" class="block bg-white/70 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition">
            <h3 class="text-sm font-semibold text-gray-500">TAN Cr√©dito</h3>
            <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{tanInfo.value}%</p>
        </a>
        <a href="/cambios" class="block bg-white/70 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition">
            <h3 class="text-sm font-semibold text-gray-500">EUR / USD</h3>
            <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{exchangeInfo.value}</p>
        </a>
        <a href="/imobiliario/risco-incumprimento" class="block bg-white/70 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition">
            <h3 class="text-sm font-semibold text-gray-500">Risco M√°ximo</h3>
            <p class="text-2xl font-bold text-red-500 mt-1">{riskInfo.value}%</p>
        </a>
      </div>
    </section>
    
    <!-- OBSERVAT√ìRIOS E FERRAMENTAS -->
    <section class="bg-white dark:bg-gray-900/40 py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 lg:grid-cols-5 gap-12">
        
        <div class="lg:col-span-3">
          <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-8">Observat√≥rios de Mercado</h2>
          <div class="space-y-6">
            <a href="/imobiliario" class="block group bg-gray-50 dark:bg-gray-800/60 p-6 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition">
              <h3 class="text-xl font-bold text-gray-900 dark:text-white group-hover:text-primary">Imobili√°rio</h3>
              <p class="mt-2 text-gray-600 dark:text-gray-400">Pre√ßos, Custo do Cr√©dito (TAN/TAEG), Risco de Incumprimento e mais.</p>
            </a>
            <a href="/euribor" class="block group bg-gray-50 dark:bg-gray-800/60 p-6 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition">
              <h3 class="text-xl font-bold text-gray-900 dark:text-white group-hover:text-primary">Taxas Euribor</h3>
              <p class="mt-2 text-gray-600 dark:text-gray-400">A evolu√ß√£o mensal das taxas que definem o seu cr√©dito habita√ß√£o.</p>
            </a>
            <a href="/cambios" class="block group bg-gray-50 dark:bg-gray-800/60 p-6 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition">
              <h3 class="text-xl font-bold text-gray-900 dark:text-white group-hover:text-primary">Taxas de C√¢mbio</h3>
              <p class="mt-2 text-gray-600 dark:text-gray-400">A cota√ß√£o do Euro (EUR) face ao D√≥lar (USD), Libra (GBP) e outras moedas.</p>
            </a>
          </div>
        </div>

        <div class="lg:col-span-2">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-8">Simuladores</h2>
            <div class="space-y-4">
                {simuladores.map((s) => (
                    <a href={`/simuladores/${s.slug}`} class="flex items-center gap-4 group bg-gray-50 dark:bg-gray-800/60 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition">
                        <div class="text-3xl">{s.emoji}</div>
                        <div>
                            <h3 class="font-bold text-gray-900 dark:text-white group-hover:text-primary">{s.titulo}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{s.desc}</p>
                        </div>
                    </a>
                ))}
            </div>
             <div class="mt-6">
                <a href="/simuladores" class="text-primary font-semibold hover:underline">Ver todos os simuladores ‚Üí</a>
            </div>
        </div>
      </div>
    </section>

    <!-- NOVA SEC√á√ÉO DE RECURSOS COM DESIGN MELHORADO -->
    <section class="bg-gray-100 dark:bg-gray-800/40 py-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-14">
          <h2 class="text-4xl font-bold text-gray-900 dark:text-white">Recursos para o Investidor</h2>
          <p class="mt-4 text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
            Desde guias fiscais detalhados a an√°lises de corretoras, temos a informa√ß√£o de que precisa para investir melhor.
          </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-stretch">
          <!-- Coluna Esquerda: Corretoras -->
          <div class="bg-white dark:bg-gray-800/60 p-8 rounded-2xl border border-gray-200 dark:border-gray-700 flex flex-col">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Corretoras & Plataformas</h3>
            <div class="space-y-4 flex-grow">
              {plataformasDestaque.map((p) => (
                  <a href={`/plataformas/${p.slug}`} class="flex items-center gap-4 group p-4 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-900/50 transition">
                      <img src={p.data.logo} alt={p.data.nome} class="h-10 w-10 object-contain rounded-full bg-white flex-shrink-0" />
                      <div>
                          <h4 class="font-bold text-gray-900 dark:text-white group-hover:text-primary">{p.data.nome}</h4>
                          <p class="text-sm text-gray-600 dark:text-gray-400">{p.data.description}</p>
                      </div>
                  </a>
              ))}
            </div>
            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="/plataformas" class="block text-center font-bold bg-primary text-white rounded-full py-3 px-8 hover:opacity-90 transition transform hover:-translate-y-1">
                    Ver Todas as Corretoras
                </a>
            </div>
          </div>
          
          <!-- Coluna Direita: Guias Fiscais -->
          <div class="bg-white dark:bg-gray-800/60 p-8 rounded-2xl border border-gray-200 dark:border-gray-700 flex flex-col">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Guias Fiscais Essenciais</h3>
            <div class="space-y-4 flex-grow">
             {guiasFiscaisDestaque.map((g) => (
              <a href={`/guias-fiscais/${g.slug}`} class="flex items-start gap-4 group p-4 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-900/50 transition">
                <div class="flex-shrink-0 h-10 w-10 mt-1 rounded-lg bg-primary/10 flex items-center justify-center border border-primary/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
                <div>
                    <h4 class="font-bold text-gray-900 dark:text-white group-hover:text-primary">{g.data.title}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 line-clamp-2">{g.data.description}</p>
                </div>
              </a>
            ))}
            </div>
            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="/guias-fiscais" class="block text-center font-bold bg-primary text-white rounded-full py-3 px-8 hover:opacity-90 transition transform hover:-translate-y-1">
                    Ver Todos os Guias
                </a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- NEWSLETTER RESTAURADA -->
    <section class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-20 text-center">
      <h2 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white mb-4">
        Receba novidades e ferramentas novas
      </h2>
      <p class="text-gray-600 dark:text-gray-400 mb-8">
        Enviamos apenas conte√∫do √∫til: novos simuladores, compara√ß√µes e alertas de oportunidades.
      </p>
      <form class="flex flex-col sm:flex-row gap-3 justify-center">
        <input
          type="email"
          placeholder="O teu email"
          class="w-full sm:w-80 px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none"
          required
        />
        <button class="bg-primary text-white font-semibold py-3 px-8 rounded-xl hover:opacity-90 transition">
          Subscrever
        </button>
      </form>
      <p class="mt-3 text-xs text-gray-400">Sem spam. Pode cancelar quando quiseres.</p>
    </section>
  </main>
</BaseLayout>