---
import BaseLayout from '~/layouts/BaseLayout.astro';
import ExchangeRatesChart from '~/components/ExchangeRatesChart.tsx';
import { getIndicator, getSeries } from '~/lib/db';

export const prerender = true;

// --- LÓGICA DE DADOS REFEITA PARA USAR A BASE DE DADOS ---
let kpis = {
  usd: { value: 'N/D', trend: 0 },
  gbp: { value: 'N/D', trend: 0 },
  chf: { value: 'N/D', trend: 0 },
};
let latestDate = "data indisponível";

try {
  // Busca os indicadores e as séries históricas da base de dados
  const usdIndicator = getIndicator('latest_exchange_rate_eur_usd');
  const gbpIndicator = getIndicator('latest_exchange_rate_eur_gbp');
  const chfIndicator = getIndicator('latest_exchange_rate_eur_chf');

  const usdHistory = getSeries('exchange_rate_eur_usd');
  const gbpHistory = getSeries('exchange_rate_eur_gbp');
  const chfHistory = getSeries('exchange_rate_eur_chf');

  // Processa os dados do USD
  if (usdIndicator && usdHistory.length >= 2) {
    kpis.usd.value = usdIndicator.value.toFixed(3);
    kpis.usd.trend = usdIndicator.value - usdHistory[usdHistory.length - 2].value;
  }
  // Processa os dados da GBP
  if (gbpIndicator && gbpHistory.length >= 2) {
    kpis.gbp.value = gbpIndicator.value.toFixed(3);
    kpis.gbp.trend = gbpIndicator.value - gbpHistory[gbpHistory.length - 2].value;
  }
  // Processa os dados do CHF
  if (chfIndicator && chfHistory.length >= 2) {
    kpis.chf.value = chfIndicator.value.toFixed(3);
    kpis.chf.trend = chfIndicator.value - chfHistory[chfHistory.length - 2].value;
  }

  if (usdIndicator) {
    latestDate = new Date(usdIndicator.reference_date).toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
  }

} catch (e) {
  console.error("Falha ao carregar dados de câmbios da base de dados:", e);
}

const trendColor = (trend: number) => {
  if (trend > 0.0001) return 'text-green-600 dark:text-green-400';
  if (trend < -0.0001) return 'text-red-600 dark:text-red-400';
  return 'text-gray-500';
};
const trendIcon = (trend: number) => {
    if (trend > 0.0001) return '▲';
    if (trend < -0.0001) return '▼';
    return '–';
}

// --- SEO (Preservado e com dados corretos) ---
const title = "Taxas de Câmbio (EUR) | Observatório Ativos.pt";
const description = `Cotação do Euro face às principais moedas mundiais. Acompanhe a evolução mensal do Dólar (USD), Libra (GBP), Franco Suíço (CHF) e mais. Último valor EUR/USD: ${kpis.usd.value}.`;
const canonical = new URL(Astro.url.pathname, Astro.site).href;

const faqSchema = { "@context":"https://schema.org","@type":"FAQPage", "mainEntity":[ {"@type":"Question","name":"O que é uma taxa de câmbio?","acceptedAnswer":{"@type":"Answer","text":"Uma taxa de câmbio é o preço de uma moeda expresso noutra moeda. Por exemplo, se a taxa EUR/USD for 1.07, significa que 1 Euro vale 1.07 Dólares Americanos."}}, {"@type":"Question","name":"O que significa quando a taxa EUR/USD sobe?","acceptedAnswer":{"@type":"Answer","text":"Quando a taxa EUR/USD sobe, significa que o Euro está a valorizar face ao Dólar. Com 1 Euro, consegue comprar mais Dólares. Isto é favorável para quem viaja da Europa para os EUA, mas pode encarecer as exportações europeias."}}, {"@type":"Question","name":"Porque é que as taxas de câmbio mudam?","acceptedAnswer":{"@type":"Answer","text":"As taxas de câmbio flutuam constantemente devido a uma variedade de fatores, incluindo as taxas de juro definidas pelos bancos centrais, a inflação, a estabilidade política e económica de um país, e a procura e oferta nos mercados cambiais."}} ] };
const datasetSchema = { "@context": "https://schema.org", "@type": "Dataset", "name": "Observatório de Taxas de Câmbio do Euro (EUR)", "description": "Série de dados históricos mensais sobre as taxas de câmbio do Euro (EUR) face a moedas chave como o Dólar Americano (USD), a Libra Esterlina (GBP) e o Franco Suíço (CHF). Os dados são recolhidos de fontes oficiais para o site Ativos.pt.", "url": new URL('/cambios', Astro.site).href, "keywords": [ "taxa de câmbio", "câmbio", "euro", "dólar", "libra", "franco suíço", "EURUSD", "EURGBP", "EURCHF", "moedas", "forex" ], "creator": { "@type": "Organization", "name": "Ativos.pt", "url": Astro.site!.href }, "license": "https://creativecommons.org/licenses/by/4.0/", "variableMeasured": "O valor de 1 Euro (EUR) expresso em outras moedas (USD, GBP, CHF)." };
---

<BaseLayout {title} {description} {canonical}>
  <Fragment slot="head">
    <script type="application/ld+json" is:inline set:html={JSON.stringify(faqSchema)} />
    <script type="application/ld+json" is:inline set:html={JSON.stringify(datasetSchema)} />
  </Fragment>

  <article class="max-w-6xl mx-auto py-12 px-4 space-y-12">
    <header class="text-center">
      <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 dark:text-white">
        Observatório de Taxas de Câmbio
      </h1>
      <p class="mt-4 text-lg text-gray-600 dark:text-gray-400 max-w-3xl mx-auto">
        A cotação do Euro face às principais moedas mundiais.
      </p>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
      <div class="p-6 bg-white dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
        <h2 class="text-sm font-bold uppercase text-gray-500 tracking-widest">Euro / Dólar (USD)</h2>
        <p class="text-4xl font-extrabold text-gray-900 dark:text-white my-2">{kpis.usd.value}</p>
        <p class:list={["text-sm font-semibold", trendColor(kpis.usd.trend)]}>
          {trendIcon(kpis.usd.trend)} {kpis.usd.trend.toFixed(4)}
        </p>
      </div>
      <div class="p-6 bg-white dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
        <h2 class="text-sm font-bold uppercase text-gray-500 tracking-widest">Euro / Libra (GBP)</h2>
        <p class="text-4xl font-extrabold text-gray-900 dark:text-white my-2">{kpis.gbp.value}</p>
        <p class:list={["text-sm font-semibold", trendColor(kpis.gbp.trend)]}>
          {trendIcon(kpis.gbp.trend)} {kpis.gbp.trend.toFixed(4)}
        </p>
      </div>
      <div class="p-6 bg-white dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
        <h2 class="text-sm font-bold uppercase text-gray-500 tracking-widest">Euro / Franco Suíço (CHF)</h2>
        <p class="text-4xl font-extrabold text-gray-900 dark:text-white my-2">{kpis.chf.value}</p>
        <p class:list={["text-sm font-semibold", trendColor(kpis.chf.trend)]}>
          {trendIcon(kpis.chf.trend)} {kpis.chf.trend.toFixed(4)}
        </p>
      </div>
      <p class="md:col-span-3 text-xs text-gray-500 dark:text-gray-400 mt-2">Câmbio de fim de mês. Última atualização: {latestDate}</p>
    </section>

    <section class="bg-white dark:bg-brand-dark border border-gray-200 dark:border-gray-700 rounded-lg p-4 sm:p-6 shadow-lg">
      <h2 class="text-2xl font-bold text-center mb-4">Evolução Histórica vs EUR</h2>
      <ExchangeRatesChart client:only="react" />
    </section>
    
    <section class="text-center">
      <a href="/cambios/comparar" class="inline-block bg-primary text-white px-8 py-3 rounded-full font-bold shadow-lg hover:scale-105 transition-transform">
        Criar Comparação Personalizada
      </a>
    </section>

    <section class="pt-8 border-t border-gray-200 dark:border-gray-700">
      <h2 class="text-3xl font-bold text-center mb-8">Como Interpretar Estes Dados</h2>
      <div class="max-w-3xl mx-auto space-y-4">
        <details class="group p-6 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 cursor-pointer">
          <summary class="flex items-center justify-between font-semibold text-lg text-gray-900 dark:text-white">
            O que é uma taxa de câmbio?
            <span class="transform transition-transform duration-300 group-open:rotate-180">▼</span>
          </summary>
          <p class="mt-4 text-gray-600 dark:text-gray-300">
            Uma taxa de câmbio é o preço de uma moeda expresso noutra. Por exemplo, se a taxa EUR/USD for 1.07, significa que 1 Euro compra 1.07 Dólares Americanos. Todos os valores mostrados são em relação a 1 Euro.
          </p>
        </details>
        <details class="group p-6 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 cursor-pointer">
          <summary class="flex items-center justify-between font-semibold text-lg text-gray-900 dark:text-white">
            O que significa quando a taxa sobe ou desce?
            <span class="transform transition-transform duration-300 group-open:rotate-180">▼</span>
          </summary>
          <p class="mt-4 text-gray-600 dark:text-gray-300">
            Quando a taxa <strong>sobe</strong>, significa que o Euro está a <strong>valorizar</strong> (está mais forte) face a essa moeda. Quando a taxa <strong>desce</strong>, o Euro está a <strong>desvalorizar</strong> (está mais fraco).
          </p>
        </details>
      </div>
    </section>
  </article>
</BaseLayout>