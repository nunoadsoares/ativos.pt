---
// packages/webapp/src/pages/euribor/quotas/[list].astro
import BaseLayout from '~/layouts/BaseLayout.astro';
import EuriborCompareChart from '~/components/EuriborCompareChart.tsx';
import { getIndicator } from '~/lib/db';

// Resolve o aviso [WARN] e garante que as páginas são geradas estaticamente
export const prerender = true;

// Gera todos os combos usando os teus nomes de URL corretos
export async function getStaticPaths() {
  const codes = ['quota3m', 'quota6m', 'quota12m'];
  const lists: string[] = [];
  function bt(i: number, path: string[]) {
    if (path.length >= 1 && path.length <= 3) {
      lists.push(path.join('-vs-'));
    }
    if (path.length === 3) return;
    for (let j = i; j < codes.length; j++) {
      path.push(codes[j]);
      bt(j + 1, path);
      path.pop();
    }
  }
  bt(0, []);
  return lists.map(l => ({ params: { list: l } }));
}

const { list } = Astro.params;
const selectedCodes = list!.split('-vs-');

const eurLabels: Record<string, string> = {
  quota3m: "Euribor 3M",
  quota6m: "Euribor 6M",
  quota12m: "Euribor 12M",
};

// Mapa para traduzir o código do URL para o código usado na BD e no componente
const codeMap: Record<string, '3m' | '6m' | '12m'> = {
  quota3m: "3m",
  quota6m: "6m",
  quota12m: "12m",
};

// LÓGICA DE BUSCA DE DADOS A PARTIR DA BASE DE DADOS
type EuriborInfo = { code: string; label: string; value: string; date: string };

const seriesInfo: EuriborInfo[] = [];
for (const code of selectedCodes) {
  const dbCode = codeMap[code];
  const indicatorKey = `latest_euribor_quota_${dbCode}`;
  const indicatorData = getIndicator(indicatorKey);

  seriesInfo.push({
    code: code,
    label: eurLabels[code],
    value: indicatorData ? indicatorData.value.toFixed(1) : "–",
    date: indicatorData ? new Date(indicatorData.reference_date).toLocaleString('pt-PT', { month: 'long', year: 'numeric' }) : "",
  });
}

const canonical = new URL(`/euribor/quotas/${list}`, Astro.site!).href;

// --- CÓDIGO JSON-LD RESTAURADO ---
const faqSchema = {
  "@context":"https://schema.org","@type":"FAQPage",
  "mainEntity":[
    {
      "@type":"Question","name":"O que é a Euribor?",
      "acceptedAnswer":{"@type":"Answer","text":"A Euribor (Euro Interbank Offered Rate) é a taxa média de juro interbancária na zona euro, usada como referência em contratos de crédito à habitação."}
    },
    {
      "@type":"Question","name":"Como se interpretam estas percentagens?",
      "acceptedAnswer":{"@type":"Answer","text":"Trata-se da percentagem de novos contratos de crédito à habitação indexados a cada prazo da Euribor."}
    }
  ]
};

const datasetSchema = {
    "@context": "https://schema.org",
    "@type": "Dataset",
    "name": `Comparador de Quota de Mercado Euribor: ${seriesInfo.map(i => i.label).join(' vs ')}`,
    "description": `Série de dados sobre a quota de mercado dos novos créditos à habitação em Portugal, indexados aos seguintes prazos da Euribor: ${seriesInfo.map(i => i.label).join(', ')}.`,
    "url": canonical,
    "keywords": [
        "euribor", "quota de mercado", "crédito habitação", "comparador",
        ...seriesInfo.map(i => i.label)
    ],
    "creator": {
        "@type": "Organization",
        "name": "Ativos.pt",
        "url": Astro.site!.href
    },
    "variableMeasured": "Percentagem de novos contratos de crédito à habitação por prazo da Euribor."
};
---

<BaseLayout
  title={`Comparador Quota Euribor: ${seriesInfo.map(i => i.label).join(' vs ')}`}
  description={`Comparação da quota de mercado dos novos créditos à habitação indexados à Euribor para os prazos: ${seriesInfo.map(i => `${i.label}: ${i.value}% (${i.date})`).join('; ')}`}
>
  <Fragment slot="head">
    <link rel="canonical" href={canonical} />
    {/* SCRIPTS JSON-LD RESTAURADOS E FUNCIONAIS */}
    <script type="application/ld+json" is:inline set:html={JSON.stringify(faqSchema)} />
    <script type="application/ld+json" is:inline set:html={JSON.stringify(datasetSchema)} />
  </Fragment>

  <article class="max-w-5xl mx-auto py-12 px-4 space-y-8">
    <h1 class="text-4xl md:text-6xl font-extrabold text-center">
      Quota de Mercado da Euribor
    </h1>

    <div class="flex flex-wrap justify-center items-center gap-3 text-lg md:text-2xl font-bold text-primary mt-2 mb-2">
      {seriesInfo.map((s, idx) => (
        <>
          <span class="font-bold">{s.label}</span>
          {idx < seriesInfo.length - 1 && <span class="mx-2 text-gray-400 font-normal">vs</span>}
        </>
      ))}
    </div>

    <p class="text-center text-lg text-gray-700 dark:text-gray-300 max-w-3xl mx-auto">
      Nesta página é possível comparar a evolução histórica da <b>percentagem de novos contratos de crédito à habitação</b> indexados a cada prazo da Euribor.<br/>
      <span class="block mt-2 text-base">
        <b>Últimos valores disponíveis:</b>
        {seriesInfo.map((s, i) => (
          <span>
            {' '}
            <span class="font-bold text-primary">{s.label}</span>
            {' — '}
            <span class="font-bold">{s.value}&nbsp;%</span>
            {s.date && <span class="text-gray-500"> ({s.date})</span>}
            {i < seriesInfo.length - 1 && <span>; </span>}
          </span>
        ))}
      </span>
    </p>

    <div class="border rounded-lg p-4 bg-white dark:bg-gray-800">
      <EuriborCompareChart
        client:only="react"
        periods={selectedCodes.map(code => codeMap[code])}
      />
      <div class="mt-2 text-xs text-gray-400 italic text-center">
        Fonte: Banco de Portugal, <a href="https://bpstat.bportugal.pt/" target="_blank" rel="noopener" class="underline hover:text-primary">BPstat</a>
      </div>
    </div>

    <div class="text-center">
      <a href="/euribor/quotas" class="text-primary underline">Selecionar outros prazos</a>
    </div>
  </article>
</BaseLayout>