---
import BaseLayout from '~/layouts/BaseLayout.astro';
import InflationHistoricalChart from '~/components/inflacao/InflationHistoricalChart.tsx';
import InflationBreakdownChart from '~/components/inflacao/InflationBreakdownChart.tsx';
import CheckboxCard from '~/components/CheckboxCard.astro';

import inflationData from '../../../public/data/inflation_summary.json';

// --- L√ìGICA PARA KPIS, TEXTO DIN√ÇMICO E SEO ---

let kpis = { yoy: 'N/D', avg12m: 'N/D', core: 'N/D' };
let latestDate = 'data indispon√≠vel';
let dynamicAnalysis = 'N√£o foi poss√≠vel carregar os dados para uma an√°lise detalhada.';
let trendArrow = '‚ÜîÔ∏è'; 
let faqItems: { question: string; answer: string }[] = [];

const sectorMap: Record<string, string> = {
    food_drinks: "Alimenta√ß√£o e Bebidas", alcoholic_tobacco: "Bebidas Alco√≥licas e Tabaco", clothing_footwear: "Vestu√°rio e Cal√ßado",
    housing_utilities: "Habita√ß√£o e Combust√≠veis", furnishings: "Mobili√°rio e Equipamentos", health: "Sa√∫de", transport: "Transportes",
    communications: "Comunica√ß√µes", recreation_culture: "Lazer e Cultura", education: "Educa√ß√£o", restaurants_hotels: "Restaurantes e Hot√©is",
    misc_goods_services: "Bens e Servi√ßos Diversos"
};
const sectorSlugs: Record<string, string> = {
    food_drinks: "alimentacao-e-bebidas", alcoholic_tobacco: "bebidas-alcoolicas-e-tabaco", clothing_footwear: "vestuario-e-calcado",
    housing_utilities: "habitacao-e-combustiveis", furnishings: "mobiliario-e-equipamentos", health: "saude", transport: "transportes",
    communications: "comunicacoes", recreation_culture: "lazer-e-cultura", education: "educacao", restaurants_hotels: "restaurantes-e-hoteis",
    misc_goods_services: "bens-e-servicos-diversos"
};
const sectorEmojis: Record<string, string> = {
    food_drinks: "üõí", alcoholic_tobacco: "üç∑", clothing_footwear: "üëü", housing_utilities: "üè†", furnishings: "üõãÔ∏è", 
    health: "‚öïÔ∏è", transport: "üöó", communications: "üì±", recreation_culture: "üé≠", education: "üéì", 
    restaurants_hotels: "üè®", misc_goods_services: "üõçÔ∏è"
};

try {
    if (inflationData.historical.yoy && inflationData.historical.yoy.length >= 2) {
        const headline = inflationData.headline;
        const historicalYoY = inflationData.historical.yoy;
        const historicalCore = inflationData.historical.core_yoy;

        const lastYoYValue = historicalYoY[historicalYoY.length - 1][1];
        const secondLastYoYValue = historicalYoY[historicalYoY.length - 2][1];
        const lastCoreValue = historicalCore.length > 0 ? historicalCore[historicalCore.length - 1][1] : null;
        
        kpis.yoy = lastYoYValue?.toFixed(2) ?? 'N/D';
        kpis.avg12m = headline['12m_avg']?.value?.toFixed(2) ?? 'N/D';
        kpis.core = lastCoreValue?.toFixed(2) ?? 'N/D';
        latestDate = new Date(headline.yoy.date).toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });

        const diffYoY = lastYoYValue - secondLastYoYValue;
        let trendText = '';
        if (diffYoY > 0.01) {
            trendArrow = 'üîº';
            trendText = `refletindo uma <strong>acelera√ß√£o</strong> face ao valor do m√™s anterior (${secondLastYoYValue.toFixed(2)}%)`;
        } else if (diffYoY < -0.01) {
            trendArrow = 'üîΩ';
            trendText = `representando um <strong>abrandamento</strong> em rela√ß√£o ao m√™s anterior (${secondLastYoYValue.toFixed(2)}%)`;
        } else {
            trendArrow = '‚ÜîÔ∏è';
            trendText = `demonstrando <strong>estabilidade</strong> em compara√ß√£o com o m√™s anterior (${secondLastYoYValue.toFixed(2)}%)`;
        }
        dynamicAnalysis = `A taxa de infla√ß√£o hom√≥loga (IPC) em Portugal fixou-se em <strong>${kpis.yoy}%</strong> ${trendArrow}, ${trendText}. A infla√ß√£o subjacente, que exclui os produtos mais vol√°teis, situou-se nos <strong>${kpis.core}%</strong>.`;
    }

    faqItems = [
        { question: "O que √© a infla√ß√£o (IPC)?", answer: "A infla√ß√£o, medida pelo √çndice de Pre√ßos no Consumidor (IPC), representa o aumento geral dos pre√ßos de um cabaz de bens e servi√ßos representativo do consumo das fam√≠lias. Uma taxa de 2% significa que, em m√©dia, o que custava 100‚Ç¨ h√° um ano, custa agora 102‚Ç¨." },
        { question: "O que significa 'Taxa de Varia√ß√£o Hom√≥loga'?", answer: "A taxa de varia√ß√£o hom√≥loga (YoY) compara o n√≠vel de pre√ßos de um determinado m√™s com o mesmo m√™s do ano anterior. √â a medida mais comum para avaliar a infla√ß√£o, pois elimina os efeitos sazonais." },
        { question: "O que √© a Infla√ß√£o Subjacente (Core)?", answer: "A infla√ß√£o subjacente exclui os pre√ßos dos produtos mais vol√°teis, como os alimentares n√£o processados e a energia. Serve para identificar a tend√™ncia de fundo da infla√ß√£o, ignorando choques de pre√ßos tempor√°rios." }
    ];

} catch (e) {
    console.error("Falha ao carregar dados da Infla√ß√£o para a p√°gina:", e);
}

const title = "Infla√ß√£o em Portugal Hoje e Hist√≥rico | Observat√≥rio Ativos.pt";
const description = `Observat√≥rio da infla√ß√£o (IPC) em Portugal. A taxa hom√≥loga em ${latestDate} foi de ${kpis.yoy}%. Consulte gr√°ficos com a evolu√ß√£o hist√≥rica e a reparti√ß√£o por categoria de consumo.`;
const canonical = new URL('/inflacao/', Astro.site).href;

const faqSchema = {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": faqItems.map(item => ({
        "@type": "Question",
        "name": item.question,
        "acceptedAnswer": { "@type": "Answer", "text": item.answer }
    }))
};

// --- NOVO C√ìDIGO JSON-LD ADICIONADO AQUI ---
const datasetSchema = {
    "@context": "https://schema.org",
    "@type": "Dataset",
    "name": "Observat√≥rio da Infla√ß√£o em Portugal (IPC)",
    "description": `S√©rie de dados sobre a evolu√ß√£o do √çndice de Pre√ßos no Consumidor em Portugal. √öltimo valor da taxa hom√≥loga (${latestDate}): ${kpis.yoy}%.`,
    "url": canonical,
    "keywords": ["infla√ß√£o", "IPC", "Portugal", "pre√ßos", "economia", "taxa de varia√ß√£o hom√≥loga"],
    "creator": {
        "@type": "Organization",
        "name": "Ativos.pt",
        "url": Astro.site.href
    },
    "license": "https://creativecommons.org/licenses/by/4.0/",
    "variableMeasured": [
        "Taxa de Varia√ß√£o Hom√≥loga do √çndice de Pre√ßos no Consumidor (IPC)",
        "Taxa de Varia√ß√£o da M√©dia M√≥vel de 12 Meses do IPC",
        "Infla√ß√£o Subjacente (IPC excluindo energia e alimentos n√£o processados)"
    ]
};
---

<BaseLayout {title} {description} {canonical}>
    <Fragment slot="head">
        <script type="application/ld+json" is:inline set:html={JSON.stringify(faqSchema)} />
    </Fragment>

    <article class="max-w-6xl mx-auto py-12 px-4 space-y-12">
        <header class="text-center">
            <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 dark:text-white">
                Observat√≥rio da Infla√ß√£o
            </h1>
            <p class="mt-4 text-lg text-gray-600 dark:text-gray-400 max-w-3xl mx-auto">
                An√°lise completa do √çndice de Pre√ßos no Consumidor (IPC) em Portugal. Dados oficiais, gr√°ficos interativos e explica√ß√µes simples.
            </p>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
            <div class="p-6 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
                <h2 class="text-sm font-bold uppercase text-primary tracking-widest">Infla√ß√£o Hom√≥loga</h2>
                <p class="text-4xl font-extrabold text-primary mt-2">{kpis.yoy}%</p>
            </div>
            <div class="p-6 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
                <h2 class="text-sm font-bold uppercase text-gray-600 dark:text-gray-400 tracking-widest">Infla√ß√£o Subjacente</h2>
                <p class="text-4xl font-extrabold text-gray-800 dark:text-gray-200 mt-2">{kpis.core}%</p>
            </div>
            <div class="p-6 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
                <h2 class="text-sm font-bold uppercase text-gray-600 dark:text-gray-400 tracking-widest">M√©dia 12 Meses</h2>
                <p class="text-4xl font-extrabold text-gray-800 dark:text-gray-200 mt-2">{kpis.avg12m}%</p>
            </div>
            <p class="md:col-span-3 text-xs text-gray-500 dark:text-gray-400 mt-2">√öltima atualiza√ß√£o: {latestDate}</p>
        </section>
        
        <section class="prose dark:prose-invert max-w-3xl mx-auto text-center text-lg">
            <p set:html={dynamicAnalysis} />
        </section>

        <section class="bg-white dark:bg-brand-dark border border-gray-200 dark:border-gray-700 rounded-lg p-4 sm:p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-center mb-2">Evolu√ß√£o Hist√≥rica da Infla√ß√£o</h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Compare a infla√ß√£o total com a infla√ß√£o subjacente.</p>
            <div class="min-h-[400px]">
                <InflationHistoricalChart client:only="react" />
            </div>
        </section>
        
        <section class="bg-white dark:bg-brand-dark border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-lg">
             <h2 class="text-2xl font-bold text-center mb-2">Compare a Infla√ß√£o Entre Setores</h2>
             <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Selecione entre 1 a 3 categorias para comparar a sua evolu√ß√£o hist√≥rica.</p>
             <div class="max-w-4xl mx-auto">
                <form id="sector-comparator-form" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                    {Object.entries(sectorMap).map(([code, label]) => (
                        <CheckboxCard value={code} label={`${sectorEmojis[code]} ${label}`} />
                    ))}
                </form>
                <div class="mt-6 flex justify-center">
                     <button id="compare-btn" type="button" class="px-8 py-3 bg-primary text-white font-bold rounded-lg shadow-md hover:opacity-90 transition-opacity">
                        Comparar Sele√ß√£o
                    </button>
                </div>
             </div>
        </section>

        <section class="bg-white dark:bg-brand-dark border border-gray-200 dark:border-gray-700 rounded-lg p-4 sm:p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-center mb-2">Infla√ß√£o por Categoria de Consumo</h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Taxa de varia√ß√£o hom√≥loga para os principais setores.</p>
            <div class="min-h-[500px]">
                <InflationBreakdownChart client:only="react" />
            </div>
        </section>

        <section class="max-w-4xl mx-auto pt-12 border-t dark:border-gray-700">
            <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white">Perguntas Frequentes</h2>
            <div class="mt-8 space-y-4">
                {faqItems.map(faq => (
                <details class="group bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg border dark:border-gray-700 cursor-pointer">
                    <summary class="flex items-center justify-between font-medium text-gray-900 dark:text-white list-none">
                        <span>{faq.question}</span>
                        <svg class="h-6 w-6 text-gray-500 group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </summary>
                    <p class="mt-3 text-gray-600 dark:text-gray-300">{faq.answer}</p>
                </details>
                ))}
            </div>
        </section>
    </article>
</BaseLayout>

<script is:inline>
    // Injetar o mapa de slugs diretamente no script para que ele n√£o tenha depend√™ncias externas
    const sectorSlugs = JSON.parse('{"food_drinks":"alimentacao-e-bebidas","alcoholic_tobacco":"bebidas-alcoolicas-e-tabaco","clothing_footwear":"vestuario-e-calcado","housing_utilities":"habitacao-e-combustiveis","furnishings":"mobiliario-e-equipamentos","health":"saude","transport":"transportes","communications":"comunicacoes","recreation_culture":"lazer-e-cultura","education":"educacao","restaurants_hotels":"restaurantes-e-hoteis","misc_goods_services":"bens-e-servicos-diversos"}');

    const form = document.getElementById('sector-comparator-form');
    const btn = document.getElementById('compare-btn');

    btn.addEventListener('click', (e) => {
        e.preventDefault();

        const checkedInputs = form.querySelectorAll('input[type="checkbox"]:checked');
        const checkedValues = Array.from(checkedInputs).map(input => input.value);

        if (checkedValues.length < 1) {
            alert('Por favor, selecione pelo menos 1 setor para analisar.');
            return;
        }
        if (checkedValues.length > 3) {
            alert('Pode comparar no m√°ximo 3 setores de cada vez.');
            return;
        }

        const slugs = checkedValues.map(value => sectorSlugs[value] || value);
        const path = slugs.join('-vs-');
        
        window.location.href = `/inflacao/${path}`;
    });
</script>