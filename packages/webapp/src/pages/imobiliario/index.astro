---
// Importações de módulos
import { promises as fs } from 'fs';
import path from 'path';
import sqlite from 'better-sqlite3';
import BaseLayout from '~/layouts/BaseLayout.astro';

// --- LÓGICA DE CARREGAMENTO DE DADOS ---
// Esta é a mesma lógica das suas páginas 'filho', mas combinada para o hub.

// 1. Dados do Preço da Habitação (de `precos-habitacao.astro`)
let housingKpi = { value: 0, date: '' };
try {
  const db = sqlite(path.resolve(process.cwd(), 'public/datahub.db'));
  const kpiRow = db.prepare("SELECT * FROM key_indicators WHERE indicator_key = 'precos_habitacao_var'").get();
  if (kpiRow) {
    housingKpi.value = kpiRow.value ?? 0;
    housingKpi.date = new Date(kpiRow.reference_date).toLocaleString('pt-PT', { month: 'long', year: 'numeric' });
  }
} catch (e) {
  console.error("Erro ao ler dados de preços da habitação:", e);
}

// 2. Dados da TAEG & TAN (de `taeg-tan.astro`)
const FILES = [{ code: 'taeg', label: 'TAEG' }]; // Apenas TAEG é suficiente para o hub
let taegInfo = { value: 'Sem Dados', date: '' };
try {
  const csvUrl = new URL(`../../../public/data/interest_rate_taeg.csv`, import.meta.url);
  const txt = await fs.readFile(csvUrl, 'utf-8');
  const rows = txt.trim().split('\n').slice(1);
  const data = rows
    .map(line => line.split(','))
    .filter(([, v]) => v !== '' && !isNaN(+v))
    .map(([d, v]) => ({ date: new Date(d), value: +v }));
  if (data.length > 0) {
    const last = data[data.length - 1];
    taegInfo.value = last.value.toFixed(2);
    taegInfo.date = last.date.toLocaleString('pt-PT', { month: 'long', year: 'numeric' });
  }
} catch (e) {
  console.error("Erro ao ler dados da TAEG:", e);
}

// 3. Dados do Risco de Incumprimento (de `risco-incumprimento.astro`)
let highestRisk = { value: 'N/D', name: 'N/D' };
try {
  const dataPath = path.resolve(process.cwd(), 'public/data/map_default_risk.json');
  const jsonData = await fs.readFile(dataPath, 'utf-8');
  const riskData: Record<string, { value: number | null; type: string }> = JSON.parse(jsonData);
  
  const validRegions = Object.entries(riskData)
    .filter(([_, data]) => data && data.value !== null)
    .map(([name, data]) => ({
      name: name,
      value: data.value as number
    }));

  if (validRegions.length > 0) {
    validRegions.sort((a, b) => b.value - a.value);
    // Verificamos se existe um primeiro elemento antes de aceder às propriedades
    if (validRegions[0]) {
      // Usamos uma verificação condicional para garantir que 'name' existe antes do 'replace'
      const name = validRegions[0].name || 'Região Desconhecida';
      highestRisk.value = validRegions[0].value.toFixed(2);
      highestRisk.name = name.replace(' (NUTS II)', '').replace(' (NUTS III)', '');
    }
  }
} catch (e) {
  console.error("Erro ao ler dados do mapa de risco:", e);
}

// --- SEO E METADADOS ---
const title = "Observatório e Guia do Mercado Imobiliário em Portugal";
const description = `Análise completa do mercado imobiliário português: descubra a evolução dos preços, o custo dos novos créditos à habitação (TAEG/TAN) e o risco de incumprimento por região.`;
const canonical = new URL('/imobiliario/', Astro.site).href;

const faqSchema = {
  "@context":"https://schema.org",
  "@type":"FAQPage",
  "mainEntity":[
    {
      "@type":"Question",
      "name":"Como posso usar este guia do mercado imobiliário?",
      "acceptedAnswer":{
        "@type":"Answer",
        "text":"Este guia reúne os dados oficiais mais importantes sobre a evolução dos preços de casas, o custo dos créditos à habitação e o risco financeiro por região. É ideal para quem quer comprar, vender ou simplesmente entender a dinâmica do mercado em Portugal."
      }
    },
    {
      "@type":"Question",
      "name":"Qual é a diferença entre TAEG e TAN?",
      "acceptedAnswer":{
        "@type":"Answer",
        "text":"A **TAEG** (Taxa Anual de Encargos Efetiva Global) inclui todos os custos do crédito (juros, comissões, seguros), dando o custo real do empréstimo. A **TAN** (Taxa Anual Nominal) é apenas a taxa de juro base."
      }
    },
    {
      "@type":"Question",
      "name":"Onde posso ver o histórico completo dos dados?",
      "acceptedAnswer":{
        "@type":"Answer",
        "text":"Pode clicar em cada um dos cartões temáticos nesta página para ser direcionado para a página detalhada, onde encontrará gráficos históricos, tabelas e análises aprofundadas sobre cada tema."
      }
    }
  ]
};
---

<BaseLayout {title} {description} {canonical}>
  <Fragment slot="head">
    <script type="application/ld+json" is:inline set:html={JSON.stringify(faqSchema)} />
    <style is:inline>
      /* Estilo Glassmorphism para os cards */
      .glass-card {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .dark .glass-card {
        background: rgba(31, 41, 55, 0.2);
        border: 1px solid rgba(55, 65, 81, 0.3);
      }
    </style>
  </Fragment>

  <article class="max-w-5xl mx-auto py-12 px-4 space-y-12">
    <!-- Header principal -->
    <header class="text-center">
      <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 dark:text-white">
        Observatório do Mercado Imobiliário
      </h1>
      <p class="mt-4 text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
        Dados oficiais, gráficos interativos e a informação essencial para tomar decisões no mercado de habitação em Portugal.
      </p>
    </header>

    <!-- Seção de KPIs Principais -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- KPI: Preços de Habitação -->
      <a href="/imobiliario/precos-habitacao" class="group relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-6 rounded-xl shadow-md transition-all hover:shadow-lg flex flex-col items-center text-center">
        <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
          Preços de Habitação
        </h2>
        <p class="mt-2 text-3xl md:text-4xl font-extrabold" class:list={[housingKpi.value > 0 ? 'text-red-500' : 'text-green-500']}>
          {housingKpi.value > 0 ? '+' : ''}{housingKpi.value}%
        </p>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          Variação Homóloga ({housingKpi.date})
        </p>
        <span class="mt-4 text-primary group-hover:underline">Explorar</span>
        <span class="absolute inset-0 rounded-xl ring-2 ring-primary opacity-0 group-hover:opacity-100 transition-opacity duration-300"></span>
      </a>

      <!-- KPI: Custo do Crédito -->
      <a href="/imobiliario/taeg-tan" class="group relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-6 rounded-xl shadow-md transition-all hover:shadow-lg flex flex-col items-center text-center">
        <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
          Custo do Crédito (TAEG)
        </h2>
        <p class="mt-2 text-3xl md:text-4xl font-extrabold text-gray-900 dark:text-white">
          {taegInfo.value !== 'Sem Dados' ? `${taegInfo.value}%` : 'Sem Dados'}
        </p>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          Última atualização ({taegInfo.date})
        </p>
        <span class="mt-4 text-primary group-hover:underline">Explorar</span>
        <span class="absolute inset-0 rounded-xl ring-2 ring-primary opacity-0 group-hover:opacity-100 transition-opacity duration-300"></span>
      </a>

      <!-- KPI: Risco de Incumprimento -->
      <a href="/imobiliario/risco-incumprimento" class="group relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-6 rounded-xl shadow-md transition-all hover:shadow-lg flex flex-col items-center text-center">
        <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
          Maior Risco de Crédito
        </h2>
        <p class="mt-2 text-3xl md:text-4xl font-extrabold text-red-600 dark:text-red-300">
          {highestRisk.value}%
        </p>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          ({highestRisk.name})
        </p>
        <span class="mt-4 text-primary group-hover:underline">Explorar</span>
        <span class="absolute inset-0 rounded-xl ring-2 ring-primary opacity-0 group-hover:opacity-100 transition-opacity duration-300"></span>
      </a>
    </section>

    <!-- Divisor e introdução -->
    <hr class="border-gray-200 dark:border-gray-700 my-12" />

    <section>
      <h2 class="text-3xl font-bold text-center mb-8 text-gray-900 dark:text-white">
        Explore os Dados em Detalhe
      </h2>
      <p class="text-lg text-gray-600 dark:text-gray-400 text-center max-w-3xl mx-auto">
        Cada secção foi desenhada para lhe dar a visão mais clara possível sobre um aspeto fundamental do mercado imobiliário português, com gráficos interativos e contexto explicativo.
      </p>
    </section>

    <!-- Secção de Cartões de Navegação -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <!-- Cartão: Preços da Habitação -->
      <a href="/imobiliario/precos-habitacao" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-lg transform transition-transform hover:scale-105 hover:shadow-xl">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">
          Observatório do Preço da Habitação
        </h3>
        <p class="mt-2 text-gray-600 dark:text-gray-400 text-sm">
          Acompanhe a evolução dos preços de venda em Portugal com a métrica oficial do INE e Banco de Portugal.
        </p>
        <div class="mt-4 text-primary font-semibold flex items-center gap-1 group-hover:underline">
          Ver Detalhes
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </div>
      </a>

      <!-- Cartão: Custo do Crédito -->
      <a href="/imobiliario/taeg-tan" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-lg transform transition-transform hover:scale-105 hover:shadow-xl">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">
          TAEG & TAN: Custo dos Créditos
        </h3>
        <p class="mt-2 text-gray-600 dark:text-gray-400 text-sm">
          Compare a evolução da Taxa Anual de Encargos Efetiva Global com a Taxa Anual Nominal.
        </p>
        <div class="mt-4 text-primary font-semibold flex items-center gap-1 group-hover:underline">
          Ver Detalhes
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </div>
      </a>
      
      <!-- Cartão: Risco de Incumprimento -->
      <a href="/imobiliario/risco-incumprimento" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-lg transform transition-transform hover:scale-105 hover:shadow-xl">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">
          Risco de Incumprimento
        </h3>
        <p class="mt-2 text-gray-600 dark:text-gray-400 text-sm">
          Consulte o ranking e o mapa das regiões com maior risco de incumprimento no crédito à habitação.
        </p>
        <div class="mt-4 text-primary font-semibold flex items-center gap-1 group-hover:underline">
          Ver Detalhes
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </div>
      </a>
    </section>

  </article>
</BaseLayout>
