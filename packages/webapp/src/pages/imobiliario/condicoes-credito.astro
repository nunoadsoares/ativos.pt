---
import BaseLayout from '~/layouts/BaseLayout.astro';
import CreditConditionsChart from '~/components/CreditConditionsChart.tsx';

interface CondicoesData {
  date: string;
  tan_variavel?: number;
  tan_fixa?: number;
  tan_mista?: number;
  prestacao_mediana?: number;
}

let latestData: Partial<CondicoesData> = {};
let latestDate = "data indisponível";

try {
  const data: CondicoesData[] = await import('../../../public/data/credito_habitacao_condicoes.json').then(m => m.default);
  if (data.length > 0) {
    latestData = data[data.length - 1];
    latestDate = new Date(latestData.date!).toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
  }
} catch (e) {
  console.error("Falha ao carregar dados das condições de crédito:", e);
}

const title = "Condições do Crédito Habitação em Portugal | Observatório";
const description = `Análise às condições atuais do crédito à habitação: TAN Fixa (${latestData.tan_fixa?.toFixed(2)}%), TAN Variável (${latestData.tan_variavel?.toFixed(2)}%) e Prestação Mensal Mediana (€${latestData.prestacao_mediana?.toFixed(2)}).`;
const canonical = new URL(Astro.url.pathname, Astro.site).href;

// --- FAQ SCHEMA ADICIONADO ---
const faqSchema = {
  "@context":"https://schema.org","@type":"FAQPage",
  "mainEntity":[
    {
      "@type":"Question","name":"O que é a TAN (Taxa Anual Nominal)?",
      "acceptedAnswer":{"@type":"Answer","text":"A TAN é a taxa de juro base do seu empréstimo, ou seja, o custo do dinheiro que o banco lhe empresta. Não inclui seguros, comissões ou outros encargos. Este gráfico mostra a mediana das TAN praticadas em novos contratos de crédito em cada mês."}
    },
    {
      "@type":"Question","name":"Qual a diferença entre Taxa Fixa e Taxa Variável?",
      "acceptedAnswer":{"@type":"Answer","text":"A Taxa Fixa mantém-se inalterada durante um período definido (ou mesmo todo o contrato), oferecendo previsibilidade na prestação. A Taxa Variável está indexada à Euribor, o que significa que a sua prestação mensal será revista (e poderá subir ou descer) a cada 3, 6 ou 12 meses, acompanhando as flutuações do mercado."}
    },
    {
      "@type":"Question","name":"O que significa a Prestação Mensal Mediana?",
      "acceptedAnswer":{"@type":"Answer","text":"A mediana é o valor 'do meio'. Se ordenarmos todas as prestações mensais dos novos contratos de crédito à habitação num determinado mês, a mediana é o valor que se encontra exatamente no centro dessa lista. Representa o que um 'típico' novo mutuário está a pagar mensalmente em Portugal."}
    }
  ]
};
---

<BaseLayout {title} {description} {canonical}>
  {/* --- SCRIPT DO SCHEMA ADICIONADO AO HEAD --- */}
  <Fragment slot="head">
    <script type="application/ld+json" is:inline set:html={JSON.stringify(faqSchema)} />
  </Fragment>

  <article class="max-w-6xl mx-auto py-12 px-4 space-y-12">
    <header class="text-center">
      <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 dark:text-white">
        Observatório das Condições de Crédito
      </h1>
      <p class="mt-4 text-lg text-gray-600 dark:text-gray-400 max-w-3xl mx-auto">
        Taxas de juro, modalidades e prestação mensal mediana dos novos contratos de crédito à habitação em Portugal.
      </p>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
      <div class="p-6 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800/50">
        <h2 class="text-sm font-bold uppercase text-red-600 dark:text-red-400 tracking-widest">TAN Fixa</h2>
        <p class="text-4xl font-extrabold text-red-600 dark:text-red-300 mt-2">
          {latestData.tan_fixa?.toFixed(2) ?? 'N/D'}%
        </p>
      </div>
      <div class="p-6 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800/50">
        <h2 class="text-sm font-bold uppercase text-blue-600 dark:text-blue-400 tracking-widest">TAN Variável</h2>
        <p class="text-4xl font-extrabold text-blue-600 dark:text-blue-300 mt-2">
          {latestData.tan_variavel?.toFixed(2) ?? 'N/D'}%
        </p>
      </div>
      <div class="p-6 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800/50">
        <h2 class="text-sm font-bold uppercase text-green-600 dark:text-green-400 tracking-widest">Prestação Mediana</h2>
        <p class="text-4xl font-extrabold text-green-600 dark:text-green-300 mt-2">
          €{latestData.prestacao_mediana?.toFixed(0) ?? 'N/D'}
        </p>
      </div>
      <p class="md:col-span-3 text-xs text-gray-500 dark:text-gray-400 mt-2">Última atualização: {latestDate}</p>
    </section>

    <section class="bg-white dark:bg-brand-dark border border-gray-200 dark:border-gray-700 rounded-lg p-4 sm:p-6 shadow-lg">
      <h2 class="text-2xl font-bold text-center mb-4">Evolução Mensal</h2>
      <CreditConditionsChart client:only="react" />
       <p class="mt-4 text-xs text-gray-500 dark:text-gray-400 italic text-center">
          Fonte dos dados: Banco de Portugal (BPstat). A TAN (Taxa Anual Nominal) representa a mediana das taxas em novos contratos. A prestação representa a mediana do valor mensal a pagar.
       </p>
    </section>

    <section class="pt-8 border-t border-gray-200 dark:border-gray-700">
      <h2 class="text-3xl font-bold text-center mb-8">Como Interpretar Estes Dados</h2>
      <div class="max-w-3xl mx-auto space-y-6">
        <details class="group p-6 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
          <summary class="flex items-center justify-between cursor-pointer font-semibold text-lg text-gray-900 dark:text-white">
            O que é a TAN (Taxa Anual Nominal)?
            <span class="transform transition-transform duration-300 group-open:rotate-180">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </span>
          </summary>
          <p class="mt-4 text-gray-600 dark:text-gray-300">
            A TAN é a <strong>taxa de juro base</strong> do seu empréstimo, ou seja, o custo do dinheiro que o banco lhe empresta. Não inclui seguros, comissões ou outros encargos. Este gráfico mostra a <strong>mediana</strong> (o valor do meio) das TAN praticadas em novos contratos de crédito em cada mês.
          </p>
        </details>
        <details class="group p-6 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
          <summary class="flex items-center justify-between cursor-pointer font-semibold text-lg text-gray-900 dark:text-white">
            Qual a diferença entre Taxa Fixa e Taxa Variável?
            <span class="transform transition-transform duration-300 group-open:rotate-180">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </span>
          </summary>
          <p class="mt-4 text-gray-600 dark:text-gray-300">
            A <strong>Taxa Fixa</strong> mantém-se inalterada durante um período definido (ou mesmo todo o contrato), oferecendo total previsibilidade na prestação. A <strong>Taxa Variável</strong> está indexada à Euribor, o que significa que a sua prestação mensal será revista (e poderá subir ou descer) a cada 3, 6 ou 12 meses, acompanhando as flutuações do mercado.
          </p>
        </details>
        <details class="group p-6 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
          <summary class="flex items-center justify-between cursor-pointer font-semibold text-lg text-gray-900 dark:text-white">
            O que significa a "Prestação Mensal Mediana"?
            <span class="transform transition-transform duration-300 group-open:rotate-180">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </span>
          </summary>
          <p class="mt-4 text-gray-600 dark:text-gray-300">
            A mediana é o valor 'do meio'. Se ordenarmos todas as prestações mensais dos novos contratos de crédito à habitação num determinado mês, a mediana é o valor que se encontra exatamente no centro dessa lista. Representa o que um <strong>'típico' novo mutuário</strong> está a pagar mensalmente em Portugal, sendo uma referência mais realista do que a média.
          </p>
        </details>
      </div>
    </section>
  </article>
</BaseLayout>