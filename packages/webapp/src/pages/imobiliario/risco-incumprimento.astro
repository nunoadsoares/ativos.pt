---
import BaseLayout from '~/layouts/BaseLayout.astro';
import DefaultRiskMap from '~/components/DefaultRiskMap.tsx';
import Database from 'better-sqlite3';
import path from 'path';

export const prerender = true;

// --- LÓGICA DE DADOS REFEITA PARA USAR A BASE DE DADOS ---
let kpis = { highest: null as any, lowest: null as any };
let tableData: { name: string; value: number; type: string }[] = [];

try {
  // Conecta diretamente à BD para buscar TODOS os indicadores de risco
  const dbPath = path.join(process.cwd(), 'public', 'datahub.db');
  const db = new Database(dbPath, { readonly: true });
  const allIndicators = db.prepare("SELECT * FROM key_indicators WHERE indicator_key LIKE 'risk_incumprimento_bportugal_%'").all() as any[];
  
  const validRegions = allIndicators
    .map(indicator => ({
      name: indicator.label.replace('Risco Incumprimento: ', '').replace(' (NUTS II)', '').replace(' (NUTS III)', ''),
      value: indicator.value,
      type: 'Habitação' // O tipo é sempre Habitação, como no script
    }));

  if (validRegions.length > 0) {
    validRegions.sort((a, b) => b.value - a.value);
    
    // Remove duplicados mantendo o nome limpo
    const uniqueRegions = [];
    const seenNames = new Set();
    for (const region of validRegions) {
      if (!seenNames.has(region.name)) {
        uniqueRegions.push(region);
        seenNames.add(region.name);
      }
    }
    tableData = uniqueRegions;
    
    kpis.highest = tableData[0];
    kpis.lowest = tableData[tableData.length - 1];
  }
} catch (e) {
  console.error("Erro ao ler ou processar os dados de risco da base de dados:", e);
}

// --- SEO (Preservado e com dados corretos) ---
const title = "Mapa e Ranking do Risco de Incumprimento em Portugal";
const description = `Análise regional da taxa de incumprimento no crédito à habitação. Veja o mapa e a tabela com as regiões de maior e menor risco. Dados de ${kpis.highest?.name}, ${kpis.lowest?.name} e mais.`;
const canonical = new URL(Astro.url.pathname, Astro.site).href;

const faqSchema = { "@context":"https://schema.org","@type":"FAQPage", "mainEntity":[ { "@type":"Question", "name":"O que mede o Risco de Incumprimento?", "acceptedAnswer": { "@type":"Answer", "text":"Este indicador mede a percentagem de devedores que têm pagamentos em atraso no seu crédito. É uma métrica importante para avaliar a saúde financeira das famílias e o risco no mercado imobiliário de uma determinada região." } }, { "@type":"Question", "name":"O que é o 'Tipo de Crédito'?", "acceptedAnswer": { "@type":"Answer", "text":"Os dados do Banco de Portugal distinguem entre crédito para Habitação e para Consumo. O nosso mapa mostra os dados de Habitação. Contudo, nem todas as regiões têm os dados atualizados, nessas situações não entram na nossa análise." } } ] };
const datasetSchema = { "@context": "https://schema.org", "@type": "Dataset", "name": "Mapa e Ranking do Risco de Incumprimento no Crédito à Habitação em Portugal", "description": `Análise regional da taxa de incumprimento no crédito à habitação em Portugal. Inclui um mapa interativo e um ranking das regiões (NUTS II e NUTS III) com as maiores e menores taxas de empréstimos vencidos. Região com maior risco: ${kpis.highest?.name} (${kpis.highest?.value}%).`, "url": canonical, "keywords": [ "risco de incumprimento", "crédito habitação", "dívida", "NPL", "non-performing loan", "mapa de risco", "portugal", "banca" ], "creator": { "@type": "Organization", "name": "Ativos.pt", "url": Astro.site!.href }, "license": "https://creativecommons.org/licenses/by/4.0/", "spatialCoverage": "Portugal" };
---
<BaseLayout {title} {description} {canonical}>
    <Fragment slot="head">
        <script type="application/ld+json" is:inline set:html={JSON.stringify(faqSchema)} />
        <script type="application/ld+json" is:inline set:html={JSON.stringify(datasetSchema)} />
    </Fragment>

    <article class="max-w-5xl mx-auto py-12 px-4 space-y-12">
        <header class="text-center">
            <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 dark:text-white">
                Mapa do Risco de Incumprimento
            </h1>
            <p class="mt-4 text-lg text-gray-600 dark:text-gray-400">
                Percentagem de devedores de crédito à habitação com empréstimos vencidos, por região.
            </p>
        </header>

        {kpis.highest && kpis.lowest && (
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800/50">
                    <h2 class="text-sm font-bold uppercase text-red-600 dark:text-red-400 tracking-widest">Maior Risco</h2>
                    <p class="text-3xl font-extrabold text-red-600 dark:text-red-300 mt-1">{kpis.highest.value}%</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{kpis.highest.name}</p>
                </div>
                <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800/50">
                    <h2 class="text-sm font-bold uppercase text-green-700 dark:text-green-400 tracking-widest">Menor Risco</h2>
                    <p class="text-3xl font-extrabold text-green-700 dark:text-green-300 mt-1">{kpis.lowest.value}%</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{kpis.lowest.name}</p>
                </div>
            </div>
        )}

        <section class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-white dark:bg-brand-dark shadow-md">
            <h3 class="font-bold text-lg mb-2 text-center">Dados Disponíveis por Região</h3>
            <p class="text-center text-xs text-gray-500 mb-4">Passe o rato sobre uma região para ver os dados das sub-regiões disponíveis.</p>
            <DefaultRiskMap client:load />
            <div class="mt-4 text-xs text-gray-500 dark:text-gray-400 italic text-center space-y-1">
                <p>Fonte dos dados estatísticos: Banco de Portugal, via <a href="https://bpstat.bportugal.pt/" target="_blank" rel="noopener" class="underline hover:text-primary">BPstat</a>.</p>
                <p>
                    Fonte dos dados geográficos: <a href="https://github.com/eurostat/Nuts2json" target="_blank" rel="noopener" class="underline hover:text-primary">Eurostat</a>, 
                    licenciado sob <a href="https://joinup.ec.europa.eu/collection/eupl/eupl-text-eupl-12" target="_blank" rel="noopener" class="underline hover:text-primary">EUPL v1.2</a>.
                </p>
            </div>
        </section>
        
        {tableData.length > 0 && (
            <section>
                <h2 class="text-3xl font-bold text-center mb-8">Ranking de Risco por Região</h2>
                <div class="overflow-x-auto bg-white dark:bg-brand-dark border border-gray-200 dark:border-gray-700 rounded-lg shadow-md">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="py-3 px-6">Região</th>
                                <th scope="col" class="py-3 px-6">Tipo de Crédito</th>
                                <th scope="col" class="py-3 px-6">Taxa de Incumprimento</th>
                            </tr>
                        </thead>
                        <tbody>
                            {tableData.map(region => (
                                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                                    <th scope="row" class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                        {region.name}
                                    </th>
                                    <td class="py-4 px-6">
                                        <span class:list={["px-2 py-0.5 text-xs rounded-full",
                                            region.type === 'Habitação' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'
                                        ]}>
                                            {region.type}
                                        </span>
                                    </td>
                                    <td class="py-4 px-6">
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-gray-800 dark:text-gray-200 w-10 text-right">{region.value}%</span>
                                            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                                <div class="bg-red-500 h-2.5 rounded-full" style={`width: ${ (region.value / kpis.highest.value) * 100 }%`}></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </section>
        )}
        
        <section class="pt-8 border-t dark:border-gray-700">
            <h2 class="text-3xl font-bold text-center mb-8">Como Interpretar Estes Dados</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-brand-dark border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-md prose dark:prose-invert max-w-none">
                    <h3 class="text-xl font-semibold mt-0">O que são "Empréstimos Vencidos"?</h3>
                    <p>Este indicador mede a percentagem de devedores que têm pagamentos em atraso no seu crédito. É uma métrica importante para avaliar a saúde financeira das famílias e o risco no mercado imobiliário de uma determinada região.</p>
                </div>
                 <div class="bg-white dark:bg-brand-dark border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-md prose dark:prose-invert max-w-none">
                    <h3 class="text-xl font-semibold mt-0">O que é o "Tipo de Crédito"?</h3>
                    <p>Os dados do Banco de Portugal distinguem entre crédito para <strong>Habitação</strong> e para <strong>Consumo</strong>. O nosso mapa mostra os dados de Habitação. Contudo, nem todas as regiões têm os dados atualizados, nessas situações não entram na nossa análise.</p>
                </div>
            </div>
        </section>
    </article>
</BaseLayout>