---
import Navbar         from '~/components/Navbar.astro';
import Footer         from '~/components/Footer.astro';
import BreadcrumbLD   from '~/components/BreadcrumbLD.astro';
import CriticalStyles from '~/components/CriticalStyles.astro';

export interface Props {
  title:        string;
  description:  string;
  canonical?:   string;
  breadcrumbs?: { name: string; url: string }[];
}

const { title, description, canonical, breadcrumbs } = Astro.props;
const canonicalURL = canonical ?? new URL(Astro.url.pathname, Astro.site!).href;

function gerarCrumbsFromUrl(path: string) {
  const parts  = path.split('/').filter(Boolean);
  const labels: Record<string, string> = {
    'guias-fiscais': 'Guias Fiscais',
    'simuladores':   'Simuladores',
    'ativos':        'Ativos',
    'plataformas':   'Corretoras'
  };
  let seg = '';
  const trail = parts.map((p) => {
    seg += `/${p}`;
    return {
      name: labels[p] ?? p.replace(/-/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase()),
      url:  `${Astro.site}${seg}/`
    };
  });
  return [{ name: 'Início', url: Astro.site }, ...trail];
}
const crumbs = breadcrumbs ?? gerarCrumbsFromUrl(Astro.url.pathname);
---

<!DOCTYPE html>
<html lang="pt-PT" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />

    <title>{title} | Ativos.pt</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph -->
    <meta property="og:type"        content="website" />
    <meta property="og:url"         content={canonicalURL} />
    <meta property="og:title"       content={`${title} | Ativos.pt`} />
    <meta property="og:description" content={description} />

    <!-- Pre-connect ao GA -->
    <link rel="preconnect" href="https://www.googletagmanager.com" />

    <!-- CSS crítico inline -->
    <CriticalStyles />

    <!-- CSS global (non-blocking load) -->
    <link
      rel="stylesheet"
      href="/styles/global.css"
      media="print"
      onload="this.media='all'"
    />

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VV97HC0LD3"></script>
    <script is:inline>
      window.addEventListener('load', () => {
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-VV97HC0LD3');
      });
    </script>

    <!-- Slot para meta extra (JSON-LD etc.) -->
    <slot name="head" />

    <!-- Breadcrumb JSON-LD -->
    <BreadcrumbLD breadcrumbs={crumbs} />

    <!-- Tema escuro/claro antes do first paint -->
    <script is:inline>
      (() => {
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') document.documentElement.classList.add('dark');
      })();
    </script>
  </head>

  <body class="bg-white dark:bg-brand-dark text-gray-800 dark:text-gray-200 antialiased">
    <Navbar />
    <main class="flex-grow">
      <slot />
    </main>
    <Footer />
  </body>
</html>
