name: Deploy to Hetzner VPS

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS (ordered, DB-first)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -Eeuo pipefail

            DOMAIN="www.ativos.pt"

            echo "→ A navegar para a pasta do projeto"
            cd /home/nuno/sites/ativos.pt

            echo "→ A atualizar o código para a versão mais recente"
            git fetch --all --prune
            git reset --hard origin/master

            echo "→ A preparar o ambiente do data-worker"
            cd packages/data-worker
            python3 -m venv .venv || true
            . .venv/bin/activate
            pip install -U pip
            pip install -r requirements.txt

            echo "→ A atualizar todos os dados (a partir da fonte de verdade)"
            python3 update_all.py

            deactivate || true
            cd - >/dev/null

            echo "→ A reconstruir e reiniciar os contentores Docker"
            docker compose up -d --build --force-recreate

            echo "→ A aguardar que a aplicação fique saudável"
            for i in $(seq 1 30); do
              status=$(docker inspect -f '{{.State.Health.Status}}' webapp-app 2>/dev/null || echo "starting")
              [ "$status" = "healthy" ] && break
              sleep 5
            done

            echo "→ Testes rápidos (smoke tests) na API"
            # Força SNI/Host correto e liga ao Nginx local (127.0.0.1)
            curl -skf --resolve "$DOMAIN:443:127.0.0.1" -H "Host: $DOMAIN" "https://$DOMAIN/api/health" \
              | tr -d " \t\n\r" | grep -q '"ok":true' \
              || { echo "✗ Health check falhou"; docker compose ps; docker compose logs --tail=200 app web; exit 1; }

            curl -skf --resolve "$DOMAIN:443:127.0.0.1" -H "Host: $DOMAIN" "https://$DOMAIN/api/data/exchangeRatesChart" >/dev/null
            curl -skf --resolve "$DOMAIN:443:127.0.0.1" -H "Host: $DOMAIN" "https://$DOMAIN/api/data/housePriceIndexChart" >/dev/null || true
            curl -skf --resolve "$DOMAIN:443:127.0.0.1" -H "Host: $DOMAIN" "https://$DOMAIN/api/data/euriborQuotasChart" >/dev/null || true

            echo "✓ Deploy concluído com sucesso!"
